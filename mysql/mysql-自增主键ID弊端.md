网上的错误观点

用 bitint 做主键不用int ，这是错的



### 弊端

#### 可靠性不高

可以回溯，在mysql 8.0才修复这个问题，自增id放内存里的，重启后有可能被回溯

如果关联的外键没有删除，会造成数据异常（小概率事件）

也不能保证顺序递增，insert 之后回滚，之前的id，没了

#### 安全性不高

同id 可以很容易猜测用户数

#### 性能差

自增ID性能差，在服务端生成（消耗服务端的性能），有自增锁抢夺的问题（锁资源的消耗，可以优化调优innodb_autoinc_lock_mode的配置）

#### 交互多

需要额外执行 last_insert_id（）的函数才能执行插入的自增id

多一次交互，海量的并发多一个交互，数据库本来就是性能瓶颈

#### 局部唯一性

当前数据库唯一，不是全局唯一

在分布式系统中，简直是恶梦



### 推荐主键设计

非核心业务：警告，日志，监控这些信息可以使用自增ID

核心业务：雪花算法



### 雪花算法

1. 整体是递增的，但是不是连续的，也不会产生也分裂

2. 但占有空间大，一页16kb存储少了（占用大的空间导致索引树每页的key变少）导致IO增多

3. 机器时钟回拨,就会导致id生成失败（算法层可以解决--记录最后一个id的时间戳--毫秒级）

4. 不同机器的时钟不是完全一致的，机器码也不同，导致全局的id并不是统一向上自增



### 自增ID 好处

MySQL官方有明确的建议主键要尽量越短越好

方便 而且 insert之后select 性能是最好的，这个优点迫使上面的缺点都可接受

例如：雪花算法id ，16kb 数据占用大了，也个页节点存储得少了，IO就多了



insert 自增和insert 雪花性能差不多

但insert之后select 性能是最好的







### 雪花算法实现

![](img\20220914142941267.png)























